package ProductQuality;

import Preprocessor.Statistics;
import Score.OneShot;
import org.apache.log4j.Logger;

/**
 * Created by supc on 2018/2/22 0022.
 * 要求每个样本的个数一致
 */
public class OneWayANOVA {
    private static final double[][] criticalTable = {
            {161.448, 199.5, 215.707, 224.583, 230.162, 233.986, 236.768, 238.883, 240.543, 241.882},
            {18.513, 19, 19.164, 19.247, 19.296, 19.33, 19.353, 19.371, 19.385, 19.396},
            {10.128, 9.552, 9.277, 9.117, 9.013, 8.941, 8.887, 8.845, 8.812, 8.786},
            {7.709, 6.944, 6.591, 6.388, 6.256, 6.163, 6.094, 6.041, 5.999, 5.964},
            {6.608, 5.786, 5.409, 5.192, 5.05, 4.95, 4.876, 4.818, 4.772, 4.735},
            {5.987, 5.143, 4.757, 4.534, 4.387, 4.284, 4.207, 4.147, 4.099, 4.06},
            {5.591, 4.737, 4.347, 4.12, 3.972, 3.866, 3.787, 3.726, 3.677, 3.637},
            {5.318, 4.459, 4.066, 3.838, 3.687, 3.581, 3.5, 3.438, 3.388, 3.347},
            {5.117, 4.256, 3.863, 3.633, 3.482, 3.374, 3.293, 3.23, 3.179, 3.137},
            {4.965, 4.103, 3.708, 3.478, 3.326, 3.217, 3.135, 3.072, 3.02, 2.978},
            {4.844, 3.982, 3.587, 3.357, 3.204, 3.095, 3.012, 2.948, 2.896, 2.854},
            {4.747, 3.885, 3.49, 3.259, 3.106, 2.996, 2.913, 2.849, 2.796, 2.753},
            {4.667, 3.806, 3.411, 3.179, 3.025, 2.915, 2.832, 2.767, 2.714, 2.671},
            {4.6, 3.739, 3.344, 3.112, 2.958, 2.848, 2.764, 2.699, 2.646, 2.602},
            {4.543, 3.682, 3.287, 3.056, 2.901, 2.79, 2.707, 2.641, 2.588, 2.544},
            {4.494, 3.634, 3.239, 3.007, 2.852, 2.741, 2.657, 2.591, 2.538, 2.494},
            {4.451, 3.592, 3.197, 2.965, 2.81, 2.699, 2.614, 2.548, 2.494, 2.45},
            {4.414, 3.555, 3.16, 2.928, 2.773, 2.661, 2.577, 2.51, 2.456, 2.412},
            {4.381, 3.522, 3.127, 2.895, 2.74, 2.628, 2.544, 2.477, 2.423, 2.378},
            {4.351, 3.493, 3.098, 2.866, 2.711, 2.599, 2.514, 2.447, 2.393, 2.348},
            {4.325, 3.467, 3.072, 2.84, 2.685, 2.573, 2.488, 2.42, 2.366, 2.321},
            {4.301, 3.443, 3.049, 2.817, 2.661, 2.549, 2.464, 2.397, 2.342, 2.297},
            {4.279, 3.422, 3.028, 2.796, 2.64, 2.528, 2.442, 2.375, 2.32, 2.275},
            {4.26, 3.403, 3.009, 2.776, 2.621, 2.508, 2.423, 2.355, 2.3, 2.255},
            {4.242, 3.385, 2.991, 2.759, 2.603, 2.49, 2.405, 2.337, 2.282, 2.236},
            {4.225, 3.369, 2.975, 2.743, 2.587, 2.474, 2.388, 2.321, 2.265, 2.22},
            {4.21, 3.354, 2.96, 2.728, 2.572, 2.459, 2.373, 2.305, 2.25, 2.204},
            {4.196, 3.34, 2.947, 2.714, 2.558, 2.445, 2.359, 2.291, 2.236, 2.19},
            {4.183, 3.328, 2.934, 2.701, 2.545, 2.432, 2.346, 2.278, 2.223, 2.177},
            {4.171, 3.316, 2.922, 2.69, 2.534, 2.421, 2.334, 2.266, 2.211, 2.165},
            {4.16, 3.305, 2.911, 2.679, 2.523, 2.409, 2.323, 2.255, 2.199, 2.153},
            {4.149, 3.295, 2.901, 2.668, 2.512, 2.399, 2.313, 2.244, 2.189, 2.142},
            {4.139, 3.285, 2.892, 2.659, 2.503, 2.389, 2.303, 2.235, 2.179, 2.133},
            {4.13, 3.276, 2.883, 2.65, 2.494, 2.38, 2.294, 2.225, 2.17, 2.123},
            {4.121, 3.267, 2.874, 2.641, 2.485, 2.372, 2.285, 2.217, 2.161, 2.114},
            {4.113, 3.259, 2.866, 2.634, 2.477, 2.364, 2.277, 2.209, 2.153, 2.106},
            {4.105, 3.252, 2.859, 2.626, 2.47, 2.356, 2.27, 2.201, 2.145, 2.098},
            {4.098, 3.245, 2.852, 2.619, 2.463, 2.349, 2.262, 2.194, 2.138, 2.091},
            {4.091, 3.238, 2.845, 2.612, 2.456, 2.342, 2.255, 2.187, 2.131, 2.084},
            {4.085, 3.232, 2.839, 2.606, 2.449, 2.336, 2.249, 2.18, 2.124, 2.077},
            {4.079, 3.226, 2.833, 2.6, 2.443, 2.33, 2.243, 2.174, 2.118, 2.071},
            {4.073, 3.22, 2.827, 2.594, 2.438, 2.324, 2.237, 2.168, 2.112, 2.065},
            {4.067, 3.214, 2.822, 2.589, 2.432, 2.318, 2.232, 2.163, 2.106, 2.059},
            {4.062, 3.209, 2.816, 2.584, 2.427, 2.313, 2.226, 2.157, 2.101, 2.054},
            {4.057, 3.204, 2.812, 2.579, 2.422, 2.308, 2.221, 2.152, 2.096, 2.049},
            {4.052, 3.2, 2.807, 2.574, 2.417, 2.304, 2.216, 2.147, 2.091, 2.044},
            {4.047, 3.195, 2.802, 2.57, 2.413, 2.299, 2.212, 2.143, 2.086, 2.039},
            {4.043, 3.191, 2.798, 2.565, 2.409, 2.295, 2.207, 2.138, 2.082, 2.035},
            {4.038, 3.187, 2.794, 2.561, 2.404, 2.29, 2.203, 2.134, 2.077, 2.03},
            {4.034, 3.183, 2.79, 2.557, 2.4, 2.286, 2.199, 2.13, 2.073, 2.026},
            {4.03, 3.179, 2.786, 2.553, 2.397, 2.283, 2.195, 2.126, 2.069, 2.022},
            {4.027, 3.175, 2.783, 2.55, 2.393, 2.279, 2.192, 2.122, 2.066, 2.018},
            {4.023, 3.172, 2.779, 2.546, 2.389, 2.275, 2.188, 2.119, 2.062, 2.015},
            {4.02, 3.168, 2.776, 2.543, 2.386, 2.272, 2.185, 2.115, 2.059, 2.011},
            {4.016, 3.165, 2.773, 2.54, 2.383, 2.269, 2.181, 2.112, 2.055, 2.008},
            {4.013, 3.162, 2.769, 2.537, 2.38, 2.266, 2.178, 2.109, 2.052, 2.005},
            {4.01, 3.159, 2.766, 2.534, 2.377, 2.263, 2.175, 2.106, 2.049, 2.001},
            {4.007, 3.156, 2.764, 2.531, 2.374, 2.26, 2.172, 2.103, 2.046, 1.998},
            {4.004, 3.153, 2.761, 2.528, 2.371, 2.257, 2.169, 2.1, 2.043, 1.995},
            {4.001, 3.15, 2.758, 2.525, 2.368, 2.254, 2.167, 2.097, 2.04, 1.993},
            {3.998, 3.148, 2.755, 2.523, 2.366, 2.251, 2.164, 2.094, 2.037, 1.99},
            {3.996, 3.145, 2.753, 2.52, 2.363, 2.249, 2.161, 2.092, 2.035, 1.987},
            {3.993, 3.143, 2.751, 2.518, 2.361, 2.246, 2.159, 2.089, 2.032, 1.985},
            {3.991, 3.14, 2.748, 2.515, 2.358, 2.244, 2.156, 2.087, 2.03, 1.982},
            {3.989, 3.138, 2.746, 2.513, 2.356, 2.242, 2.154, 2.084, 2.027, 1.98},
            {3.986, 3.136, 2.744, 2.511, 2.354, 2.239, 2.152, 2.082, 2.025, 1.977},
            {3.984, 3.134, 2.742, 2.509, 2.352, 2.237, 2.15, 2.08, 2.023, 1.975},
            {3.982, 3.132, 2.74, 2.507, 2.35, 2.235, 2.148, 2.078, 2.021, 1.973},
            {3.98, 3.13, 2.737, 2.505, 2.348, 2.233, 2.145, 2.076, 2.019, 1.971},
            {3.978, 3.128, 2.736, 2.503, 2.346, 2.231, 2.143, 2.074, 2.017, 1.969},
            {3.976, 3.126, 2.734, 2.501, 2.344, 2.229, 2.142, 2.072, 2.015, 1.967},
            {3.974, 3.124, 2.732, 2.499, 2.342, 2.227, 2.14, 2.07, 2.013, 1.965},
            {3.972, 3.122, 2.73, 2.497, 2.34, 2.226, 2.138, 2.068, 2.011, 1.963},
            {3.97, 3.12, 2.728, 2.495, 2.338, 2.224, 2.136, 2.066, 2.009, 1.961},
            {3.968, 3.119, 2.727, 2.494, 2.337, 2.222, 2.134, 2.064, 2.007, 1.959},
            {3.967, 3.117, 2.725, 2.492, 2.335, 2.22, 2.133, 2.063, 2.006, 1.958},
            {3.965, 3.115, 2.723, 2.49, 2.333, 2.219, 2.131, 2.061, 2.004, 1.956},
            {3.963, 3.114, 2.722, 2.489, 2.332, 2.217, 2.129, 2.059, 2.002, 1.954},
            {3.962, 3.112, 2.72, 2.487, 2.33, 2.216, 2.128, 2.058, 2.001, 1.953},
            {3.96, 3.111, 2.719, 2.486, 2.329, 2.214, 2.126, 2.056, 1.999, 1.951},
            {3.959, 3.109, 2.717, 2.484, 2.327, 2.213, 2.125, 2.055, 1.998, 1.95},
            {3.957, 3.108, 2.716, 2.483, 2.326, 2.211, 2.123, 2.053, 1.996, 1.948},
            {3.956, 3.107, 2.715, 2.482, 2.324, 2.21, 2.122, 2.052, 1.995, 1.947},
            {3.955, 3.105, 2.713, 2.48, 2.323, 2.209, 2.121, 2.051, 1.993, 1.945},
            {3.953, 3.104, 2.712, 2.479, 2.322, 2.207, 2.119, 2.049, 1.992, 1.944},
            {3.952, 3.103, 2.711, 2.478, 2.321, 2.206, 2.118, 2.048, 1.991, 1.943},
            {3.951, 3.101, 2.709, 2.476, 2.319, 2.205, 2.117, 2.047, 1.989, 1.941},
            {3.949, 3.1, 2.708, 2.475, 2.318, 2.203, 2.115, 2.045, 1.988, 1.94},
            {3.948, 3.099, 2.707, 2.474, 2.317, 2.202, 2.114, 2.044, 1.987, 1.939},
            {3.947, 3.098, 2.706, 2.473, 2.316, 2.201, 2.113, 2.043, 1.986, 1.938},
            {3.946, 3.097, 2.705, 2.472, 2.315, 2.2, 2.112, 2.042, 1.984, 1.936},
            {3.945, 3.095, 2.704, 2.471, 2.313, 2.199, 2.111, 2.041, 1.983, 1.935},
            {3.943, 3.094, 2.703, 2.47, 2.312, 2.198, 2.11, 2.04, 1.982, 1.934},
            {3.942, 3.093, 2.701, 2.469, 2.311, 2.197, 2.109, 2.038, 1.981, 1.933},
            {3.941, 3.092, 2.7, 2.467, 2.31, 2.196, 2.108, 2.037, 1.98, 1.932},
            {3.94, 3.091, 2.699, 2.466, 2.309, 2.195, 2.106, 2.036, 1.979, 1.931},
            {3.939, 3.09, 2.698, 2.465, 2.308, 2.194, 2.105, 2.035, 1.978, 1.93},
            {3.938, 3.089, 2.697, 2.465, 2.307, 2.193, 2.104, 2.034, 1.977, 1.929},
            {3.937, 3.088, 2.696, 2.464, 2.306, 2.192, 2.103, 2.033, 1.976, 1.928},
            {3.936, 3.087, 2.696, 2.463, 2.305, 2.191, 2.103, 2.032, 1.975, 1.927}
    };
    private static final Logger log = Logger.getLogger(OneWayANOVA.class);

    private double[] xMean; //各个样本均值
    private double populationMean; //总体均值
    private double SST; //总平方和
    private double SSA; //组间平方和
    private double SSE; //组内平方和
    private double MSA; //组间均方差
    private double MSE; // 组内均方差
    private int n;
    private int k;
    private double F;
    private double FCritical;

    /*
    * 如果返回true表明存在显著差异
    * 如果返回false表明不存在显著差异
     */
    public boolean m_OneWayANOVA(double[][] dataSet) throws Exception {
        log.info("单因素方差分析方法被调用");

        int nRow = dataSet.length;
        int nColumn = dataSet[0].length;
        this.k = nColumn;
        xMean = new double[nColumn];

        //计算各个样本的均值
        double[] tmp = new double[nRow];
        for (int j = 0; j < nColumn; j++) {
            for (int i = 0; i < nRow; i++) {
                tmp[i] = dataSet[i][j];
            }
            xMean[j] = Statistics.getAverage(tmp);
        }
        //总体均值
        this.n = nRow * nColumn;
        if((n-k) > 100 || (k-1) > 10) {
            log.error("使用单因素方差分析时，数据超出查表范围，请降低数据的数量");
            throw new Exception("使用单因素方差分析时，数据超出查表范围，请降低数据的数量");
        }
        populationMean = Statistics.getAverage(xMean);

        //各类误差平方和
        SST = 0;
        for (int i = 0; i < nRow; i++) {
            for (int j = 0; j < nColumn; j++) {
                SST += Math.pow((dataSet[i][j] - populationMean), 2);
            }
        }

        SSA = 0;
        for (int j = 0; j < nColumn; j++) {
            SSA += nRow * Math.pow((xMean[j] - populationMean), 2);
        }

        SSE = 0;
        for (int j = 0; j < nColumn; j++) {
            for (int i = 0; i < nRow; i++) {
                SSE += Math.pow((dataSet[i][j] - xMean[j]), 2);
            }
        }

        MSA = SSA / (k - 1);
        MSE = SSE / (n - k);

        F = MSA / MSE;
        FCritical = criticalTable[n - k - 1][k - 1 - 1];
        //存在显著关系
        if (F >= FCritical) {
            return true;
        }
        //不存在显著关系
        return false;
    }


    public double getSST() {
        return SST;
    }

    public double getSSA() {
        return SSA;
    }

    public double getSSE() {
        return SSE;
    }

    public double getMSA() {
        return MSA;
    }

    public double getMSE() {
        return MSE;
    }

    public int getN() {
        return n;
    }

    public int getK() {
        return k;
    }

    public double getF() {
        return F;
    }

    public double getFCritical() {
        return FCritical;
    }
}
